!function(){"use strict";function t(t){var e=Math.floor(t/4)+L;return"mv"==vt.type?e%2==0?e:"":e}function e(t){ct||void 0!==ht[t.id]&&lt.show(t)}function n(t){lt.hide(t)}function a(t){ct?st.show(t):pt.zoomOnCountry(t.country_id)}function r(t){ct?st.show(t):void 0!==ht[t.country_id]&&lt.show(t)}function o(t){st.hide(t)}function i(t,a){function r(t,e,n){if(void 0===e&&(e=!0),ct=!0,n=n||750,p.cid===t)return o();d3.selectAll(".circle").style("pointer-events","auto"),e&&u("country_id",t),p.classed("active",!1),p=d3.select("#country-"+t).classed("active",!0),p.cid=t;var a=_.find(x,function(e){return e.id==t}),r=g.bounds(a),i=r[1][0]-r[0][0],s=r[1][1]-r[0][1],d=(r[0][0]+r[1][0])/2,f=(r[0][1]+r[1][1])/2,m=.9/Math.max(i/l,s/(c-h.bottom)),v=[l/2-m*d,c/2-m*f-h.bottom/2];y.transition().duration(n).style("stroke-width",1.5/m+"px").attr("transform","translate("+v+")scale("+m+")")}function o(t){t=t||750,ct=!1,f("country_id"),p.classed("active",!1),p=d3.select(null);var e=ot,n=e[1][0]-e[0][0],a=e[1][1]-e[0][1],r=(e[0][0]+e[1][0])/2,o=(e[0][1]+e[1][1])/2,i=1/Math.max(n/l,a/c),d=[l/2-i*r,c/2-i*o+s];y.transition().duration(t).style("stroke-width",1.5/i+"px").attr("transform","translate("+d+")scale("+i+")"),d3.selectAll(".circle").style("pointer-events","none")}function i(t){return m}var c,l=vt.width,s=0;"mh"==vt.type?c=vt.height:(c=vt.height-X+250,"mv"==vt.type&&(console.log("mv"),s=30));var d=c/2,p=d3.select(null),m=d3.geo.wagner4().rotate([-30,5]).scale(d).translate([l/2,c/2+s]).precision(.1),h={};h.bottom=X-50;var g=d3.geo.path().projection(m);ot=g.bounds(topojson.feature(a,a.objects.countries));var v=d3.select(t).attr("width",l).attr("height",c).style("height",c+"px");v.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",g),v.append("use").attr("class","map-stroke").attr("xlink:href","#sphere"),v.append("use").attr("class","map-fill").attr("xlink:href","#sphere"),v.call(st),v.call(lt);var y=v.append("g").attr("class","map-all");y.insert("path").datum(topojson.feature(a,a.objects.land)).attr("class","map-land").attr("d",g);var x=topojson.feature(a,a.objects.countries).features,k=y.append("g",".map-land");return k.selectAll("path").data(x).enter().append("path").attr("d",g).attr("id",function(t){return"country-"+t.id}).attr("class","map-state").on("mouseover",e).on("mouseout",n).on("click",function(t){r(t.id)}),y.append("path",".map-graticule").datum(topojson.mesh(a,a.objects.countries,function(t,e){return t!==e})).attr("class","map-boundary").attr("d",g),y.append("g").attr("class","pings"),o(),{projection:i,resetZoom:o,zoomOnCountry:r}}function c(t,e,n){{var a=d3.select(t);d3.geo.path().projection(n)}a.call(ut),e=e.map(function(t){return t.x=n([t.lng,t.lat])[0],t.y=n([t.lng,t.lat])[1],t.radius=1,t});for(var r=e.length,o=d3.geom.quadtree(e),i=0;++i<r;)o.visit(d(e[i]));for(;++i<r;)o.visit(d(e[i]));var c=a.select(".map-all"),l=tt.means_of_attack;c.append("g").attr("class","bubble").selectAll(".circle").data(e).enter().append("circle").attr("class","circle").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).style("fill",function(t){return l(t.means_of_attack)}).attr("r",1.3),s(e)}function l(t){var e=t.map(function(t){return t.id}),n=tt.means_of_attack;d3.selectAll(".circle").style("fill",function(t){return e.indexOf(t.id)>-1?n(t.means_of_attack):"#cccccc"}).classed("e-active",function(t){return e.indexOf(t.id)>-1?!0:!1}).attr("r",function(t){return e.indexOf(t.id)>-1?1.3:.8}).on("mouseover",function(t){e.indexOf(t.id)>-1&&r(t)}).on("mouseout",o).on("click",function(t){e.indexOf(t.id)>-1&&a(t)}),d3.selectAll(".e-active").moveToFront()}function s(t){var e=d3.nest().key(function(t){return t.country_id}).rollup(function(t){return t.length}).entries(t),n={};e.map(function(t){n[t.key]=t.values});var a=d3.scale.quantile().domain(d3.extent(e,function(t){return t.values})).range(rt);d3.selectAll(".map-state").style("fill",function(t){return a(n[t.id])})}function d(t){var e=0,n=t.radius+1,a=t.x-n,r=t.x+n,o=t.y-n,i=t.y+n;return function(n,c,l,s,d){if(n.point&&n.point!==t){var u=t.x-n.point.x,f=t.y-n.point.y,p=Math.sqrt(u*u+f*f),m=t.radius+n.point.radius;m>p&&(0==p&&(e+=1,p=.1,u=Math.sqrt(p)*Math.cos(Math.PI/3*e),f=Math.sqrt(p)*Math.sin(Math.PI/3*e)),p=(p-m)/p*.5,t.x-=u*=p,t.y-=f*=p,n.point.x+=u,n.point.y+=f)}return c>r||a>s||l>i||o>d}}function u(t,e){if(mt[t]=e,"country_id"==t){var n=$("#fcountry").val();n!=e&&$("#fcountry").selectpicker("val",String(e))}p()}function f(t,e){t in mt&&(delete mt[t],p(),"country_id"==t&&$("#fcountry").selectpicker("val","all"))}function p(){var t=it.slice();Object.keys(mt).map(function(e){"time"!=e&&"country_id"!=e&&"ngo"!=e&&(t=t.filter(function(t){return t[e]==mt[e]}))}),"ngo"in mt&&(t=t.filter(function(t){return t[mt.ngo]>0}));var e=t.slice();"time"in mt&&(t=t.filter(function(t){return t.bucket>=mt.time[0]&&t.bucket<mt.time[1]}),e=e.map(function(t){return t.off=t.bucket<mt.time[0]||t.bucket>=mt.time[1]?!0:!1,t})),s(t),"country_id"in mt&&(t=t.filter(function(t){return t.country_id==mt.country_id}),e=e.filter(function(t){return t.country_id==mt.country_id})),N(e),l(t.slice()),F(t)}function m(t,e){var n=$(t).val();"all"==n?f(e):u(e,n)}function h(t){dt.append("g").attr("id","means_of_attack"),dt.append("g").attr("id","attack_context"),dt.append("g").attr("id","location"),dt.append("g").attr("id","country"),dt.append("g").attr("id","ngo");g(t)}function g(t){v(t,"means_of_attack",5)}function v(t,e,n){var a=20,r=220,o=y(t,e);0==tt[e].domain().length&&(tt[e]=tt[e].domain(o.map(function(t){return t.key})));var i=d3.scale.linear().domain([0,d3.sum(o,function(t){return t.values})]).range([0,r]),c=d3.select("#"+e).selectAll("rect").data(o,function(t){return t.key});c.transition().ease("linear").duration(Y).attr("x",function(t){return i(t.prev)}).attr("width",function(t){return i(t.values+t.prev)-i(t.prev)}),c.enter().append("rect").attr("height",a).style("fill",function(t){return console.log(t),tt[e](t.key)}).attr("x",function(t){return i(t.prev)}).attr("width",function(t){return i(t.values+t.prev)-i(t.prev)}).attr("y",n),c.exit().remove()}function y(t,e){if("ngo"==e){var n=[],a=Object.keys(H);a.map(function(e){n.push({key:e,values:d3.sum(t,function(t){return t[e]})})})}else var n=d3.nest().key(function(t){return t[e]}).rollup(function(t){return t.length}).entries(t);return n.sort(function(t,e){return t.values>e.values?-1:t.values<e.values?1:0}),n.map(function(t){return t.values}).reduce(function(t,e,a,r){return n[a].prev=t,t+e}),n[0].prev=0,console.log(n),n}function x(){ft=!0}function k(t,e,n,a,r){var o=0,i=J.map(function(t){return 1e3*moment(t.date).unix()}),c=(d3.geo.path().projection(a),d3.select(n).select(".pings")),l=parseInt(t[0].time,10),s=parseInt(t[t.length-1].time,10)+2592e6,d=l,u=(new Date).getTime(),f=function(){d3.select("#date").text(moment(d).utc().format("MMM DD YYYY"))},p=d3.scale.linear().domain([0,100]).range([l,s]),m=d3.scale.linear().domain([0,G]).range([0,s-l]);d3.select("#slider").on("change",function(t){d=p(d3.event.target.value),f()}).call(d3.behavior.drag().on("dragstart",function(){ft=!0}).on("dragend",function(){ft=!1})),d3.timer(function(){var n=(new Date).getTime();if(ft)return void(u=n);var l=n-u;l>500&&(l=500);for(var p=m(l),h=t.filter(function(t){return t.time<=d+p}),g=h.filter(function(t){return t.time>d&&t.time<=d+p}),v=0;v<g.length;v++){var y=g[v];e.add(y.lng,y.lat,{angle:et(y.mag),id:y.id,ttl:nt(y.mag)})}if(N(h,!0),d+=p,e.draw(c,a,new Date),o<i.length&&d>i[o]){var x=J[o].text;x?(d3.select("#text").text(x),d3.select("#textbutton").on("click",b),d3.select("#message").classed("hidden",!1),ft=!0,pt.zoomOnCountry(J[o].zoom,!1,1200)):pt.resetZoom(1e3),o+=1}return d>s?(r(),!0):(f(),F(h),void(u=n))})}function b(){d3.select("#message").classed("hidden",!0),ft=!1}function w(t,e,n){console.log(t+"-> "+n)}function A(){"intro"==yt.current&&yt.startExplore()}function M(){"dashboard"==yt.current&&yt.back()}function j(){vt.width=window.innerWidth,vt.height=window.innerHeight,Math.max(vt.width,vt.height)<W?(d3.select("#mobilenote").classed("hidden",!1),vt.type=vt.width>vt.height?"mh":"mv"):vt.type="lg"}function O(t,e,n){if(t)return void alert("Problem loading the data.");n=D(n),it=n,it.map(function(t){ht[t.country_id]=t.country,gt.push(t.country_id)}),pt=i("#mapoverlay",e),R(n);var a=I();"dashboard"==a?yt.loadDashboard():yt.loadIntro()}function I(){var t=window.location.href,e=t.substr(t.lastIndexOf("#")+1);return"explore"==e?"dashboard":"intro"}function S(){d3.select("#skip").on("click",M).text("Back").classed("hidden",!0);var t=it;P(),N(t),$("#helpModal").modal("show"),d3.select("#messages").classed("hidden",!0),d3.select("#date").classed("hidden",!0),d3.select("#note3").classed("hidden",!1),d3.select("#sfilters").classed("hidden",!1),d3.select("#slegend").classed("hidden",!1),c("#mapoverlay",t,pt.projection()),h(t),$("#fcontext").change(function(t){m("#fcontext","attack_context")}),$("#flocation").change(function(t){m("#flocation","location")}),$("#fmeans").change(function(t){m("#fmeans","means_of_attack")}),$("#forg").change(function(t){m("#forg","ngo")}),$("#fcountry").change(function(t){var e=$("#fcountry").val();"all"==e?pt.resetZoom():pt.zoomOnCountry(e)}),d3.select("#message").classed("hidden",!0),F(t)}function T(){d3.select("#date").classed("hidden",!1),d3.select("#slegend").classed("hidden",!0),d3.select("#note3").classed("hidden",!0),d3.select("#sfilters").classed("hidden",!0),$("#myModal").modal("show"),$("#modal-continue").on("click",z),d3.select("#skip").on("click",A).text("Skip")}function z(){$("#myModal").modal("hide"),d3.select("#skip").classed("hidden",!1);var t=q({});k(it,t,"#mapoverlay",pt.projection(),C)}function C(){yt.startExplore()}function D(t){var e=Object.keys(H);return t.map(function(t){return t.mag=t.total_affected,t.time=+t.time,t.day=+t.day,t.month=+t.month,t.bucket=+t.bucket,t.lat=+t.lat,t.lng=+t.lng,t.country_id=+t.country_id,e.map(function(e){t[e]=+t[e]}),t})}function F(e){var n,a;n=d3.sum(e,function(t){return t.total_nationals}),a=d3.sum(e,function(t){return t.total_internationals});var r=L,o=V;"time"in mt&&(r=t(mt.time[0]),o=t(mt.time[1])),d3.select("#casualties").text(n+" nationals and "+a+" internationals affected between "+r+" and "+o)}function q(t){var e=[];t=t||{};var n=function(n,a,r){r=r||{},r.color=r.color||t.color||"white",r.angle=r.angle||t.angle||5,r.ttl=r.ttl||t.ttl||2e3;var o={time:new Date,options:r};t.latitudeFirst?(o.lat=n,o.lng=a):(o.lng=n,o.lat=a),e.push(o)},a=function(t,n,a){for(var r=[],o=0;o<e.length;o++){var i=e[o],c=a-i.time;c<i.options.ttl&&r.push(i)}e=r;var l=d3.select(".pings").selectAll("circle").data(r,function(t){return t.options.id});l.enter().append("circle").attr("class","ping").attr("cx",function(t){return n([t.lng,t.lat])[0]}).attr("cy",function(t){return n([t.lng,t.lat])[1]}).style("fill","#ff0000").attr("r",5),l.transition().attr("cx",function(t){return n([t.lng,t.lat])[0]}).attr("cy",function(t){return n([t.lng,t.lat])[1]}).style("fill","#ff0000").attr("r",.5),l.exit().attr("r",function(t){}).remove()};return{add:n,draw:a}}function E(){d3.select(".pings").selectAll("circle").remove()}function R(e){var n=d3.select("#timeline");("mv"==vt.type||"mh"==vt.type)&&(xt=2,Mt.right=10,Mt.left=30),"mh"==vt.type&&(bt=80,Mt.top=8,Mt.right=175);var a=vt.width-Mt.left-Mt.right,r=d3.extent(e.map(function(t){return t.bucket}));_t=_t.domain([r[0],r[1]+1]).range([0,a]);var o=[0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,60],i=d3.svg.axis().scale(_t).orient("bottom").tickSize(6).outerTickSize(0).tickValues(o).tickFormat(t);n.append("g").attr("class","x axis axis-victims").attr("transform","translate("+Mt.left+",0)").call(wt).selectAll("text").attr("y",0).attr("x",-9).attr("dy",".35em").attr("transform","rotate(-10)").style("text-anchor","end"),d3.select(".axis-victims").append("text").attr("y",Mt.top-4).attr("x",3).attr("dy",".71em").style("text-anchor","start").text("Casualties per quarter"),n.append("g").attr("class","y axis").attr("transform","translate("+Mt.left+","+(Mt.top+bt)+")").call(i).selectAll("text").attr("y",10).attr("x",2).attr("dy",".35em").style("text-anchor","start"),n.append("g").attr("class","v-legend").selectAll("rect").data(at.domain()).enter().append("rect").attr("width",5).attr("height",5).attr("y",Mt.top+At+bt).attr("x",function(t,e){return Mt.left+10+60*e}).style("fill",at),n.select(".v-legend").selectAll("text").data(at.domain()).enter().append("text").attr("y",Mt.top+At+bt+5).attr("x",function(t,e){return Mt.left+20+60*e}).text(function(t,e){return t}),n.append("g").attr("id","victims"),U()}function U(){var t=tt.means_of_attack,e=200,n=140,a=20;("mh"==vt.type||"mv"==vt.type)&&(e=150,n=102,a=14);var r=d3.select("#legend").attr("width",e).style("width",e+"px").style("height",n+"px").attr("height",n);r.append("g").attr("class","legend").selectAll("rect").data(t.domain()).enter().append("circle").attr("r",5).attr("cx",e-10).attr("cy",function(t,e){return 10+e*a}).style("fill",t),r.select(".legend").selectAll("text").data(t.domain()).enter().append("text").attr("x",e-20).attr("y",function(t,e){return 15+e*a}).text(function(t,e){return Z[t]})}function P(){var t=_t.domain(),e=d3.select("#timeline"),n=d3.svg.arc().outerRadius(.75*At).startAngle(0).endAngle(function(t,e){return e?-Math.PI:Math.PI});kt.x(_t).extent(t).on("brushend",K);var a=e.append("g").attr("transform","translate("+Mt.left+","+Mt.top+")").attr("class","x brush").call(kt);a.selectAll("rect").attr("height",bt+At),a.selectAll(".resize").append("path").attr("transform","translate(0,"+(bt/2+At/2)+")").attr("d",n)}function K(){if(d3.event.sourceEvent){var t=kt.extent();t[0]=Math.round(t[0]),t[1]=Math.round(t[1]),u("time",t),d3.select(this).transition().call(kt.extent(t)).call(kt.event)}}function N(t,e){var n=(d3.select("#timeline"),tt[jt]),a=d3.nest().key(function(t){return t.bucket}).sortKeys(d3.ascending).entries(t);a=a.map(function(t){return t.kidnapped=d3.sum(t.values,function(t){return t.total_kidnapped}),t.killed=d3.sum(t.values,function(t){return t.total_killed}),t.wounded=d3.sum(t.values,function(t){return t.total_wounded}),t}),a.forEach(function(t){var e=0;t.off=t.values[0].off,t.types=at.domain().map(function(n){return{name:n,y0:e,y1:e+=+t[n],off:t.off}}),t.total=t.types[t.types.length-1].y1});var r=d3.nest().key(function(t){return t.bucket}).sortKeys(d3.ascending).key(function(t){return t[jt]}).sortKeys(d3.ascending).rollup(function(t){return t.length}).entries(t);if(r.forEach(function(t,e){n.domain().map(function(e){t[e]=0}),t.values.map(function(e){t[e.key]=e.values});var r=0;t.types=n.domain().map(function(n){return{name:n,y0:r,y1:r+=+t[n],off:a[e].off}}),t.total=t.types[t.types.length-1].y1}),e)var o=d3.scale.linear().domain([0,176]).range([bt+Mt.top,Mt.top]);else var o=d3.scale.linear().domain([0,d3.max(a.map(function(t){return t.total}))]).range([bt+Mt.top,Mt.top]);wt=wt.scale(o).tickFormat(d3.format("d")),d3.select(".axis-victims").transition().duration(Y).ease("sin-in-out").call(wt);var i=d3.select("#victims").selectAll(".bucket").data(a,function(t){return t.key});i.enter().append("g").attr("class","bucket").attr("transform",function(t){return"translate("+(_t(t.key)+Mt.left)+",0)"});var c=i.selectAll("rect").data(function(t){return t.types});c.transition().ease("linear").duration(Y).style("fill",function(t){var e=at(t.name);if(1==t.off){var e=d3.hsl(e);return e.s=0,e.toString()}return e}).attr("height",function(t){return o(t.y0)-o(t.y1)}).attr("y",function(t){return o(t.y1)}),c.enter().append("rect").attr("width",xt).style("fill",function(t){return at(t.name)}).attr("height",function(t){return o(t.y0)-o(t.y1)}).attr("y",function(t){return o(t.y1)}),i.exit().remove()}var Y=300,G=5e4,L=2e3,V=2015,Z={I:"IEDs",B:"Explosives",S:"Shooting or bodily assault",L:"Landmine/UXO",R:"Sexual Violence",K:"Kidnap",U:"Unknown"},B={Am:"Ambush/attack on road",C:"Combat (or police operations) / Crossfire",IA:"Individual attack or assassination",MV:"Mob violence, rioting",R:"Raid (armed incursion by group)",D:"Detention (by official government forces or police)",U:"Unknown"},H={un:"UN",ingo:"INGO",lgno_ncrs:"LGNO/NCRS",icrc:"ICRC",ifrc:"IFRC",other:"other"},J=(Object.keys(B),[{date:"2001-10-01T00:00:00",text:"October 2001 - Following the 9/11 attacks, the US-led coalition overthrew the Taliban regime, but conflict continues. The country accounts for almost a quarter of all attacks, twice as many as the next highest country.",zoom:4},{date:"2002-01-01T00:00:00",zoom:-1},{date:"2003-02-01T00:00:00",text:"February 2003 – Start of conflict in Sudan’s Darfur region. Over 200 attacks have occurred in the country.",zoom:729},{date:"2003-08-01T00:00:00",zoom:-1},{date:"2007-01-01T00:00:00",text:"Rise of Al Shabaab extremist group in Somalia. The country has the second most incidents.",zoom:706},{date:"2007-07-01T00:00:00",zoom:-1},{date:"2011-07-01T00:00:00",text:"July 2011 - Independence of South Sudan. Initial hopes have given way to despair as the country has descended into civil war.",zoom:728},{date:"2011-09-01T00:00:00",text:"2011- Syrian uprising becomes a civil war. The country, which had not seen a single aid worker attack before 2011, has seen nearly 100 since.",zoom:760},{date:"2011-12-01T00:00:00",zoom:-1}]),W=762,X=250,Q=["rgb(228,26,28)","rgb(55,126,184)","rgb(77,175,74)","rgb(152,78,163)","rgb(255,127,0)","rgb(255,255,51)","rgb(166,86,40)"],tt={attack_context:d3.scale.category10(),location:d3.scale.category10(),means_of_attack:d3.scale.ordinal().range(Q),country:d3.scale.category20(),org:d3.scale.category10(),ngo:d3.scale.category10()},et=d3.scale.sqrt().domain([1,200]).range([5,20]),nt=d3.scale.pow().exponent(3).domain([2.5,100]).range([1e3,5e3]),at=d3.scale.ordinal().domain(["killed","wounded","kidnapped"]).range(["#ff0000","#FF5800","#cccccc"]);tt.means_of_attack.domain(Object.keys(Z));var rt=["rgb(189,189,189)","rgb(150,150,150)","rgb(115,115,115)","rgb(82,82,82)","rgb(37,37,37)"];rt.reverse(),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var ot,it,ct=!1,lt=d3.tip().attr("class","d3-tip").direction("e").offset([0,8]).html(function(t){var e;return e="country_id"in t?ht[t.country_id]:ht[t.id],"<span style='color:red'>"+e+"</span>"}),st=d3.tip().attr("class","d3-tip").offset([0,10]).direction("e").html(function(t){var e="Unknown";t.region&&(e=t.region),t.city&&(e+=", "+t.city);var n=t.year;t.month&&(n+="-"+t.month,t.day&&(n+="-"+t.day));var a="<span class='tip-label'>Place: </span><span class='tip-value'>"+e+"</span>";return a+="</br><span class='tip-label'>Date: </span><span class='tip-value'>"+n+"</span>",a+="</br><span>"+t["details_(public)"]+"</span>"}),dt=d3.select("#dist").attr("width",230).attr("height",30),ut=d3.tip().offset([2,0]).direction("s").html(function(t){return"<span style='color:red'>"+t.key+"</span>"}),ft=!1,pt=null,mt={},ht={},gt=[],vt={},yt=StateMachine.create({initial:"start",events:[{name:"loadIntro",from:"start",to:"intro"},{name:"loadDashboard",from:"start",to:"dashboard"},{name:"startExplore",from:"intro",to:"dashboard"},{name:"back",from:"dashboard",to:"intro"}],callbacks:{onbeforeloadIntro:function(t,e,n){},onleavestart:function(t,e,n){w("ols",e,n)},onleaveintro:function(t,e,n){w("oli",e,n),E(),x()},onintro:function(t,e,n){w("od",e,n),T()},ondashboard:function(t,e,n){w("od",e,n),S()},onleaveflat:function(t,e,n){toGlobe(e,n)}}});j(),queue(2).defer(d3.json,"data/world-110m.json").defer(d3.csv,"data/data.csv").await(O);var xt=5,kt=d3.svg.brush(),bt=120,wt=d3.svg.axis().orient("left"),_t=d3.scale.linear(),At=20,Mt={left:60,right:60,top:8,bottom:0},jt="means_of_attack"}();
